---
layout: default
title: Composite monitors
nav_order: 3
parent: Alerting
has_children: false
redirect_from:
---

# Composite monitors

---

#### Table of contents
- TOC
{:toc}

---

## About composite monitors

Basic [monitor types]({{site.url}}{{site.baseurl}}/observing-your-data/alerting/monitors/#monitor-types) for the Alerting plugin are designed to define a single trigger type. For example, a document level monitor can trigger an alert based on a query's match with documents, while a bucket level monitor can trigger an alert based on queries aimed at aggregated values in a data source. The composite monitor extends the usefulness of the individual monitor types by providing functionality that can chain the output of multiple monitor types into a single workflow that includes multiple triggers and permits analysis of a data source based on multiple criteria. This allows you to derive more granular information about a data source, and it doesn't require you to manually coordinate the scheduling of the separate monitors.

Composite monitors solve limitations with basic monitors in the following ways:

* Composite monitors give you the ability to create complex queries through a combination of triggers generated by multiple types of monitors.
* They have the capacity to define a pipeline of rules and queries that are run as a single execution.
* They can chain together individual monitors so that the output of one can act as the input for the next, repeating this through the entire sequence of the execution.
* They provide a more complete view of a given data source by running multiple monitors and multiple types of monitors in sequence, creating finer focused results and reducing noise in the results.


## Key terms

The key terms in the following table describe the basic concepts behind composite monitors. For additional terms common to all types of monitors, see [Key terms]({{site.url}}{{site.baseurl}}/observing-your-data/alerting/monitors/#key-terms) for basic monitors.

| Term | Definition |
| :--- | :--- |
| Composite monitor | A combination of multiple individual monitors that includes functionality to execute each monitor in a sequence. The composite monitor can query different aspects of a dataset based on the type of monitors included in the composite monitor's definition.  |
| Delegate monitor | Any monitor used in the chained workflow of a composite monitor. Composite monitors support per query, per bucket, and per document monitor types as delegate monitors. Delegate monitors are executed sequentially according to their order in the monitor definition. |
| workflow Id | The workflow Id provides an identifier for the entire workflow of all delegate monitors. It is synonymous with a composite monitor's monitor Id. |
| Chained alert | Chained alerts are generated from composite monitor triggers when delegate monitors generate alerts. The chained alert trigger condition supports the use of the logical operators AND, OR, and NOT so you can combine multiple functions into a single expression. |
| Audit alert | Delegate monitors generate alerts in an **audit** state. Users are not notified about each individual audit alert and don't need to acknowledge them. Audit alerts are used to evaluate chained alert trigger conditions in composite monitors. |
| Execution | A single run of all delegate monitors in the sequence defined in the composite monitor's configuration. |
| Execution Id | Allows for the management of data recorded from a specific execution of a composite monitor. The execution Id associates findings and alerts with the execution and is stored in each monitor's metadata, along with the workflow Id and the monitor Id. |


## Managing composite monitors with the API

You can manage composite monitors using the REST API or OpenSearch Dashboards. This section covers API functionality for composite monitors.


### Create Composite Monitor

This API allows you to create a composite monitor.

```json
POST _plugins/_alerting/workflows
```
{% include copy-curl.html %}

#### Request fields

| Field | Type | Description |
| :--- | :--- | :--- |
| `schedule` | Object | The schedule that determines how often the execution runs. |
| `schedule.period.interval` | Numeral | Accepts a numerical value to set how often the execution runs. |
| `schedule.period.unit` | Object | The time unit of measure for the interval. `SECONDS`, `MINUTES`, `HOURS`, `DAYS`. |
| `inputs` | Object | Accepts inputs to define the delegate monitors, which specify both the delegate monitors and their order in the execution's sequence. |
| `inputs.composite_input.sequence.delegates` | Object | Settings for the individual monitors that underlie the composite monitor. |
| `inputs.composite_input.sequence.delegates.order` | Number | Designates the order in which the monitor runs in the execution. |
| `inputs.composite_input.sequence.delegates.monitor_id` | String | The unique identifier for the monitor. |
| `enabled_time` | Number | Time at which the monitor was enabled. Expressed in epoch time. |
| `enabled` | Boolean | Setting to determine whether the composite monitor is enabled or not. Setting it to `true` enables the composite monitor. Default is TBD. |
| `workflow_type` | String | Set to `composite` for composite monitor. |
| `triggers` | Object | Details for the individual alert triggers. |
| `triggers.chained_alert_trigger` | Object | Details for each individual alert trigger. Each monitor's alert trigger will require settings for its configuration. |
| `triggers.chained_alert_trigger.id` | String | The unique identifier for the alert trigger. |
| `triggers.chained_alert_trigger.name` | String | The name of the alert trigger. |
| `triggers.chained_alert_trigger.severity` | Number | The alert severity. 1 = highest; 2 = high; 3 = medium; 4 = low; 5 = lowest.|
| `triggers.chained_alert_trigger.condition.script` | Object | The script details that determine the conditions for triggering an alert. |
| `triggers.chained_alert_trigger.condition.script.source` | String | The Painless script that defines the conditions for triggering an alert. |
| `triggers.chained_alert_trigger.condition.script.lang` | String | Enter `painless` for the Painless scripting language. |

#### Example request

```json
POST _plugins/_alerting/workflows
{
    "last_update_time": 1679468231835,
    "owner": "alerting",
    "type": "workflow",
    "schedule": {
        "period": {
            "interval": 1,
            "unit": "MINUTES"
        }
    },
    "inputs": [
        {
            "composite_input": {
                "sequence": {
                    "delegates": [
                        {
                            "order": 1,
                            "monitor_id": "grsbCIcBvEHfkjWFeCqb"
                        },
                        {
                            "order": 2,
                            "monitor_id": "agasbCIcBvEHfkjWFeCqa"
                        }
                    ]
                }
            }
        }
    ],
    "enabled_time": 1679468231835,
    "enabled": true,
    "workflow_type": "composite",
    "schema_version": 0,
    "name": "scale_up",
    "triggers": [
        {
            "chained_alert_trigger": {
                "id": "m1ANDm2",
                "name": "jnkjn",
                "severity": "1",
                "condition": {
                    "script": {
                        "source": "(monitor[id={{m1}}] && monitor[id={{m2}}])", //ALERT WILL BE CREATED IF MONITOR 1 GENERATES ALERTS AND MONITOR 2 DOESN'T GENERATE ALERT",
                        "lang": "painless"
                    }
                }
            }
        },
        {
            "chained_alert_trigger": {
                "id": "m1ORm2",
                "name": "jnkjn",
                "severity": "1",
                "condition": {
                    "script": {
                        "source": "(monitor[id={{m1}}] || monitor[id={{m2}}])", //ALERT WILL BE CREATED IF MONITOR 1 GENERATES ALERTS OR MONITOR 2 GENERATE ALERT",
                        "lang": "painless"
                    }
                }
            }
        }
    ]
}
```
{% include copy-curl.html %}

#### Using Painless scripting language to define alert trigger chains

Composite monitor configuration employs the [Painless scripting language](https://www.elastic.co/guide/en/elasticsearch/painless/7.17/painless-guide.html) to define the conditions for chaining alerts. Conditions are applied for each execution of the composite monitor. You specify the definition for the chain in the `triggers.chained_alert_triggers.condition.script.source` field of the request. Using Painless syntax, you can apply logic to links between monitors with basic Boolean operators AND, OR, NOT, and precedence.

* AND = `&&`
* OR = `||`
* NOT = `!`
* Precedence = `()`

See the following examples to understand how each is used in the monitor definition.

* **Example 1**
   
   `monitor[id=1] && monitor[id=2]`
   
   The following conditions for delegate monitors will trigger the composite monitor to produce an alert when both monitor #1 AND monitor #2 generate an alert.

* **Example 2**
   
   `monitor[id=1] || monitor[id=2]`

   The following conditions will trigger the composite monitor to produce an alert when either monitor #1 OR monitor #2 generates an alert.

* **Example 3**
   
   `monitor[id=1] && (!monitor[id=2] || monitor[id=3])`

   The following conditions will trigger the composite monitor to produce an alert when monitor #1 generates an alert AND monitor #2 does NOT, OR, monitor #3 does generate an alert.
   
The order of monitor IDs in the Painless script does not define the sequence of execution for the monitors. The sequence of monitor execution is defined in the `inputs.composite_input.sequence.delegates.order` field in the request.
{: .note }


### Get Composite Monitor

This API retrieves information on the specified monitor.

```json
GET _plugins/_alerting/workflows/<workflow_id>
```
{% include copy-curl.html %}

#### Path parameters

| Field | Type | Description |
| :--- | :--- | :--- |
| `workflow_id` | String | The composite monitor's [workflow Id](#key-terms). |


### Update Composite Monitor

This API updates the composite monitor's details. See [Create Composite Monitor](#create-composite-monitor) for description of request fields.

```json
PUT _plugins/_alerting/workflows/<workflow_id>
{
    "owner": "security_analytics",
    "type": "workflow",
    "schedule": {
        "period": {
        "interval": 1,
        "unit": "MINUTES"
        }
    },
    "inputs": [
        {
            "composite_input": {
                "sequence": {
                    "delegates": [
                        {
                            "order": 1,
                            "monitor_id": "grsbCIcBvEHfkjWFeCqb"
                        },
                        {
                            "order": 1,
                            "monitor_id": "agasbCIcBvEHfkjWFeCqa"
                        }
                    ]
                }
            }
        }
    ],
    "enabled_time": 1679468231835,
    "enabled": true,
    "workflow_type": "composite",
 
    "name": "NTxdwApKbv"
}
```
{% include copy-curl.html %}


### Delete Composite Monitor

```json
DELETE _plugins/_alerting/workflows/<workflow_id>
```
{% include copy-curl.html %}


### Execute Composite Monitor

This API begins the workflow execution for a composite monitor.

```json
POST /_plugins/_alerting/workflows/<workflow_id>/_execute
```
{% include copy-curl.html %}

#### Example response

```json
{
    "execution_id": "I0GXeIgBYKBG2nHoiHCL_2023-06-01T20:18:48.511884_a9c1d055-9b70-49c2-b32a-716cff1f562e",
    "workflow_name": "scale_up",
    "workflow_id": "I0GXeIgBYKBG2nHoiHCL",
    "trigger_results": {
        "m1ANDm2": {
            "name": "jnkjn",
            "triggered": true,
            "action_results": {},
            "error": null
        },
        "m1ORm2": {
            "name": "jnkjn",
            "triggered": true,
            "action_results": {},
            "error": null
        }
    },
    "monitor_run_results": [{
            "monitor_name": "test triggers",
            "period_start": 1685650668501,
            "period_end": 1685650728501,
            "error": null,
            "input_results": {
                "results": [{
                    "bhjh": [
                        "OkGceIgBYKBG2nHoyHAn|test1",
                        "O0GceIgBYKBG2nHozHCW|test1"
                    ],
                    "nkjkj": [
                        "OkGceIgBYKBG2nHoyHAn|test1",
                        "O0GceIgBYKBG2nHozHCW|test1"
                    ],
                    "jknkjn": [
                        "OkGceIgBYKBG2nHoyHAn|test1",
                        "O0GceIgBYKBG2nHozHCW|test1"
                    ]
                }],
                "error": null
            },
            "trigger_results": {
                "NC3Dd4cBCDCIfBYtViLI": {
                    "name": "njkkj",
                    "triggeredDocs": [
                        "OkGceIgBYKBG2nHoyHAn|test1",
                        "O0GceIgBYKBG2nHozHCW|test1"
                    ],
                    "action_results": {},
                    "error": null
                }
            }
        },
        {
            "monitor_name": "test triggers 2",
            "period_start": 1685650668501,
            "period_end": 1685650728501,
            "error": null,
            "input_results": {
                "results": [{
                    "bhjh": [
                        "PEGceIgBYKBG2nHo1HCw|test",
                        "PUGceIgBYKBG2nHo3HA8|test"
                    ],
                    "nkjkj": [
                        "PEGceIgBYKBG2nHo1HCw|test",
                        "PUGceIgBYKBG2nHo3HA8|test"
                    ],
                    "jknkjn": [
                        "PEGceIgBYKBG2nHo1HCw|test",
                        "PUGceIgBYKBG2nHo3HA8|test"
                    ]
                }],
                "error": null
            },
            "trigger_results": {
                "NC3Dd4cBCDCIfBYtViLI": {
                    "name": "njkkj",
                    "triggeredDocs": [
                        "PEGceIgBYKBG2nHo1HCw|test",
                        "PUGceIgBYKBG2nHo3HA8|test"
                    ],
                    "action_results": {},
                    "error": null
                }
            }
        }
    ],
    "execution_start_time": "2023-06-01T20:18:48.511874Z",
    "execution_end_time": "2023-06-01T20:18:53.682405Z",
    "error": null
}
```


### Acknowledge Chained Alerts

This API provides a list of chained alerts belonging to a specific workflow. 

```json
POST _plugins/_alerting/workflows/<workflow_id>/_acknowledge/alerts
{
    "alerts": ["eQURa3gBKo1jAh6qUo49"]
}
```
{% include copy-curl.html %}

#### Request fields

| Field | Type | Description |
| :--- | :--- | :--- |
| `alerts` | Array | A list of alerts by Id. The results include alerts that are acknowledged by the system as well as alerts not recognized by the system. |

#### Example response

```json
{
    "success": [
    "eQURa3gBKo1jAh6qUo49"
    ],
    "failed": []
}
```

## Creating composite monitors in OpenSearch Dashboards

Begin by navigating to the **Create monitor** page in OpenSearch Dashboards: **Alerting > Monitors > Create monitor**. Then select **Composite monitor** as the monitor type in the **Monitor details** section. Steps for creating a composite monitor workflow and triggers vary depending on whether you use the **Visual editor** or the **Extraction query editor**. In either case, the first step is to define the schedule.

In the **Frequency** dropdown list, select either **By interval**, **Daily**, **Weekly**, **Monthly**, or **Custom cron expression**.
  * **By interval** — Allows you to run the schedule repeatedly based on the number of minutes, hours, or days you specify.
  * **Daily** — Specify a time of day and a timezone.
  * **Weekly** — Specify a day of the week, a time of day, and a timezone.
  * **Monthly** — Specify a day of the month, a time of day, and a timezone.
  * **Custom cron expression** — Create a custom cron expression for the schedule. Use the **cron expressions** link for help with creating these expressions, or see [Cron expression reference]({{site.url}}{{site.baseurl}}/observing-your-data/alerting/cron/).

For the remaining steps, refer to either **Visual editor** or the **Extraction query editor** in the following sections.

### Visual editor

To use the visual editor for defining a workflow and triggers, select the **Visual editor** radio button in the **Monitor defining method** section. This is shown in the following image.

<img src="{{site.url}}{{site.baseurl}}/images/alerting/vis-editor.png" alt="Selecting the Visual editor" width="50%">

To finish creating a composite monitor in the Visual editor, follow these steps:

1. In the **Delegate monitors** section, enter the individual monitors you want to include in the workflow by selecting them in the dropdown lists. In the **Visual editor**, the order in which you select the monitors determines their order in the workflow.
  
   Select **Add another monitor** to add another dropdown list. A minimum of two delegate monitors are required, and a maximum of 10 are allowed in total. Keep in mind that composite monitors support per query, per bucket, and per document monitors as delegate monitors.
   
   Beside each dropdown list, you can select the View monitor icon ({::nomarkdown}<img src="{{site.url}}{{site.baseurl}}/images/dashboards/view-monitor-icon.png" class="inline-icon" alt="view monitor icon"/>{:/}) to open the monitor's details window and review information about it.
   
1. Define a trigger or triggers for the composite monitor. In the **Triggers** section, select **Add trigger**. Add a trigger name, then define the trigger conditions.
    * Use the **Select delegate monitor** label to open the condition and monitor selector popup window.
    
    <img src="{{site.url}}{{site.baseurl}}/images/alerting/trigger1.png" alt="This popup window shows options for selecting a delegate monitor and trigger condition operator" width="50%">
    
    * First use the **Select delegate monitor** dropdown list to select a delegate monitor from those defined in the previous step. After the monitor is populated in the field, you can use the trash can icon ({::nomarkdown}<img src="{{site.url}}{{site.baseurl}}/images/alerting/trash-can-icon.png" class="inline-icon" alt="trash can icon"/>{:/}) to the right of the list to remove the monitor if needed.
    * Before a second delegate monitor has been selected, the list of operators provides the option NOT. You can select NOT to dismiss this detector as a condition for the trigger. Otherwise, leave the operator's field blank.
    * Select the plus sign to the right of the first monitor to select a second. Use the **Select delegate monitor** dropdown list to select a second delegate monitor. After a second monitor has been populated, you can select a Boolean operator to define the conditions between the two delegate monitors. The options include AND, OR, AND NOT, and OR NOT. After the operator is applied, you can always select the operator between the two monitors to open the dropdown list and change the selection.
    * Select the severity level for the alert. The options include 1 (Highest), 2 (High), 3 (Medium), 4 (Low), and 5 (Lowest).
    * In the **Notifications** section, select a notification channel from the dropdown list. If no channels exist, select the **Manage channels** label to the right of the dropdown list to set up a notification channel. For more information about notifications, see the [Notifications]({{site.url}}{{site.baseurl}}/observing-your-data/notifications/index/) documentation. You can also select **Add notification** to specify additional notifications for the alert trigger.
      
      Notifications are optional for all monitor types.
      {: .note }

    * To define an additional trigger, select **Add another trigger**. You can have a maximum of of 10 triggers in total. Select **Remove trigger** to the right of the screen to remove a trigger.
    
1. After completing the monitor workflow and defining triggers, select **Create** in the bottom right corner of the screen. The composite monitor is created, and the monitor's details window opens.

### Extraction query editor

To use the extraction query editor for defining a workflow and triggers, select the **Extraction query editor** radio button in the **Monitor defining method** section. This is shown in the following image.

<img src="{{site.url}}{{site.baseurl}}/images/alerting/extract-q-editor.png" alt="Selecting the Extraction query editor" width="50%">

The extraction query editor follows the same general steps as the visual editor, but it allows you to build the composite monitor workflow and alert triggers using extractions from the API query. This provides you with an ability create more advanced configurations not supported by the visual editor. The following sections provide examples of content for each of these two fields. All other steps for composite monitor creation are the same as in those for the Visual editor.

* **Define workflow**
  
  In the **Define workflow** field, enter a sequence that defines the delegate monitors and their order in the workflow. The following example shows the delegate monitors that are included in the workflow along with their order in the sequence:

  ```json
  {
      "sequence": {
          "delegates": [
              {
                  "order": 1,
                  "monitor_id": "0TgBZokB2ZtsLaRvXz70"
              },
              {
                  "order": 2,
                  "monitor_id": "8jgBZokB2ZtsLaRv6z4N"
              }
          ]
      }
  }
  ```
  
  All delegate monitors included in the workflow require a `monitor_id` and a value for `order`.
  
* **Trigger condition**
  
  In the **Trigger condition** field, enter the monitors and the operators that will be used to define the conditions between them. This field requires that trigger conditions be formatted in Painless scripting language. To see how these scripts are formed for trigger conditions, see [Using Painless scripting to define alert trigger chains](#using-painless-scripting-language-to-define-alert-trigger-chains).

  The following example shows a trigger condition requiring the first monitor OR the second monitor to generate an audit alert before the composite monitor can generate its own alert:

  ```painless
  (monitor[id=8d36S4kB0DWOHH7wpkET] || monitor[id=4t36S4kB0DWOHH7wL0Hk])
  ```

